name: Deploy App
on: [push, workflow_dispatch]

env:
  IMAGE_NAME: flask-demo
  REGISTRY_URL: asaurasacr.azurecr.io

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v2  # Ensure to use the latest version of checkout action

    - name: 'Login to Azure'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Login to Docker Registry'
      uses: docker/login-action@v1
      with:
        registry: ${{ env.REGISTRY_URL }}
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: Set image version
      id: image-version
      run: echo "IMAGE_VERSION=$(echo ${GITHUB_REF#refs/heads/}/$(date +'%Y.%m.%d.%H.%M'))" >> $GITHUB_ENV

    - name: 'Build and push image'
      run: |
        docker build . -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_VERSION }}
        docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_VERSION }}
        docker tag ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_VERSION }} ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest

    - name: 'Deploy to Azure Web App'
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'asauras-webapp'
        images: '${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_VERSION }}'
